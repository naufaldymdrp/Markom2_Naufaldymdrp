@page "{handler?}"
@model Markom2.Web.Pages.Master.MCompanyModel
@{
}

<div class="row">
    <div class="col-sm">
        <h4>Company Master Data</h4>
        <!-- BreadCrumb Navigation -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">Home</li>
                <li class="breadcrumb-item">Master</li>
                <li class="breadcrumb-item active" aria-current="page">Master Company</li>
            </ol>
        </nav>
        <!-- /BreadCrumb Navigation -->
        <!-- 'Transparent' table for filter form -->
        <form class="row d-flex justify-content-end" id="SearchCompanyForm">
            <table class="table table-borderless">
                <tbody>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>
                            <button href="#" id="AddCompanyModalButton" class="btn btn-primary">
                                <span class="fas fa-plus" aria-hidden="true"></span>
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <input asp-for="Company.Code" class="form-control" />
                        </td>
                        <td>
                            <input asp-for="Company.Name" class="form-control" />
                        </td>
                        <td>
                            <input asp-for="Company.CreatedDate" type="date" class="form-control" />
                        </td>
                        <td>
                            <input asp-for="Company.CreatedBy" class="form-control" />
                        </td>
                        <td>
                            <button type="submit" href="#" id="SearchCompanyButton" class="btn btn-warning">
                                <span class="fas fa-search-plus" aria-hidden="true"></span>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </form>
        <!-- /'Transparent' table for filter form -->
        <table class="table">
            <thead>
                <tr>
                    <th>@Html.DisplayNameFor(item => item.Companies[0].Id)</th>
                    <th>@Html.DisplayNameFor(item => item.Companies[0].Code)</th>
                    <th>@Html.DisplayNameFor(item => item.Companies[0].Name)</th>
                    <th>@Html.DisplayNameFor(item => item.Companies[0].CreatedDate)</th>
                    <th>Created By</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="MCompanyTableBody">
                <partial name="MCompanyPartials/_MCompanyListPartial" for="Companies" />
            </tbody>
        </table>
    </div>
</div>

@section Scripts
{
    <partial name="_ValidationScriptsPartial" />
    <script type="text/javascript">

        $(document).ready(() => {
            // Penambahan MCompany baru

            $("#AddCompanyModalButton").on("click", () => {
                $.ajax({
                    url: "MCompany/AddMCompanyPartial",
                    accepts: "text/html",
                    success: e => {
                        $("#ModalContent").append(e);
                        $("form#MCompanyFormPartial").removeData("validator");
                        $("form#MCompanyFormPartial").removeData("unobtrusiveValidation");
                        $.validator.unobtrusive.parse("form#MCompanyFormPartial");
                    },
                    error: err => {
                        var errDetailJson = err.responseJson;
                        $("#ModalContent").append(errDetailJson);
                    }
                });

                showModal();
            });

            $(document).on("submit", "#AddMCompanyForm", (ev) => {
                ev.preventDefault();
                console.log("submit baru");
                let formValue = $("#AddMCompanyForm").serialize();
                if (formValue != undefined) {
                    $.post("MCompany/AddMCompany", formValue, data => {
                        //debugger;
                        console.log("sukses");
                        //console.log(data);
                        $("#MCompanyTableBody").empty();
                        $("#MCompanyTableBody").append(data);
                        closeModal();
                    }).fail(data => {
                        //debugger;
                        console.log("gagal");
                        console.log(data);
                    });
                }
            });

            // / Penambahan MCompany baru

            // Memuat Detail MCompany

            $(document).on("click", "span.mcompany-detail-button", (ev) => {
                let clickedId = {
                    dataId: ev.target.id
                };
                $.get("MCompany/DetailMCompanyPartial", clickedId, (data) => {
                    $("#ModalContent").empty();
                    $("#ModalContent").append(data);
                    showModal();
                }).fail(data => {
                    alert("gagal, cek kembali data atau hubungi Tim IT");
                    console.log(data.responseText);
                });
            });

            // /Memuat detail MCompany

            /** Memuat Edit Company **/
            $(document).on("click", "span.mcompany-edit-button", (ev) => {
                let clickedId = {
                    dataId: ev.target.id
                };
                $.get("MCompany/EditMCompanyPartial", clickedId, data => {
                    console.log("edit-button sukses");
                    $("#ModalContent").empty();
                    $("#ModalContent").append(data);
                    showModal();
                }).fail(data => {
                    alert("gagal, cek kembali data atau hubungi tim IT");
                    console.log(data.responseText);
                });
            });
            /** /Memuat Edit Company **/

            // Melakukan edit Company 
            $(document).on("submit", "#EditMCompanyForm", ev => {
                ev.preventDefault();

                var formValue = $(".MCompanyFormPartial").serialize();
                $.post("MCompany/EditMCompany", formValue, data => {
                    console.log("submit edit sukses");
                    $("#MCompanyTableBody").empty();
                    $("#MCompanyTableBody").append(data);
                    closeModal();
                }).fail(data => {
                    alert("gagal, cek kembali data atau hubungi tim IT");
                    console.log(data.responseText);
                    closeModal();
                });
            });

            // Memuat formulir delete form
            $(document).on("click", "span.mcompany-delete-button", ev => {
                var clickedId = {
                    dataId: ev.target.id
                };

                $.get("MCompany/DeleteMCompanyPartial", clickedId, data => {
                    $("#ModalContent").empty();
                    $("#ModalContent").append(data);
                    showModal();
                }).fail(data => {
                    alert("gagal, cek kembali data atau hubungi tim IT");
                    console.log(data.responseText);
                });
            });
            // /Memuat formulir delete form

            // Melakukan delete (ubah isDelete) 
            $(document).on("submit", "#DeleteMCompanyForm", ev => {
                ev.preventDefault();                
                var data = {
                    DataId: $("#DeleteMCompanyForm input[name='Item1.Id']").val()
                };         
                console.log(JSON.stringify(data));
                $.ajax({
                    type: "POST",
                    url: "MCompany/DeleteMCompany",
                    headers: {
                        "RequestVerificationToken": $("#DeleteMCompanyForm input[name='__RequestVerificationToken']").val()
                    },
                    data: JSON.stringify(data),
                    contentType: "application/json; charset=utf-8"                    
                }).done((data) => {
                    console.log("sukses");
                    $("#MCompanyTableBody").empty();
                    $("#MCompanyTableBody").append(data);
                    closeModal();
                }).fail(data => {
                    alert(`gagal, cek kembali data atau hubungi tim IT, keterangan ${data.responseText}`);
                    console.log(data.responseText);
                    closeModal();
                });                
            });
            // /Melakukan delete

            $("#SearchCompanyForm").on("submit", (ev) => {
                ev.preventDefault();
                let searchFormValue = $("#SearchCompanyForm").serialize();

                $.get("MCompany/Search", searchFormValue, data => {
                    console.log("sukses");
                    $("#MCompanyTableBody").empty();
                    $("#MCompanyTableBody").append(data);
                }).fail(data => {
                    console.log("gagal");
                    console.log(data.responseText);
                });
            });

            $(document).on("click", "#MCompanyModalCloser", () => {
                closeModal();
            });

        });
    </script>

}